# ./docker-compose-hive-superset-sqlite.yaml

services:
  # -------------------------------------------------------------------------
  # SQLite Service (Minimal Metastore DB)
  # A very lightweight SQLite database for the Hive Metastore
  # -------------------------------------------------------------------------
  sqlite:
    image: nouchka/sqlite3:latest
    container_name: sqlite_metastore_db
    volumes:
      # This volume ensures your metastore data is persistent
      - sqlite_data:/data
    networks:
      - my_shared_network
    # This command keeps the container running so other services can connect
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]

    # -------------------------------------------------------------------------
    # Hive Metastore Service
    # The central repository for Hive's metadata (table schemas, partitions, etc.)
    # -------------------------------------------------------------------------
  hive-metastore:
    image: apache/hive:3.1.3
    container_name: hive_metastore
    ports:
      # Default Hive Metastore port
      - "9083:9083"
    environment:
      # Database driver and connection URL for the SQLite Metastore
      - SERVICE_NAME=metastore
      # Note: We use the container name 'sqlite' to connect to the database
      - METASTORE_DB_HOSTNAME=sqlite
      - METASTORE_DB_TYPE=sqlite
      - METASTORE_DB_NAME=/data/metastore.db
    # Ensure the SQLite service is up and ready before starting the Metastore
    depends_on:
      - sqlite
    networks:
      - my_shared_network

  # -------------------------------------------------------------------------
  # Superset Initializer Service
  # Runs one-time setup (DB init, admin user creation)
  # -------------------------------------------------------------------------
  superset-init:
    image: apache/superset:3.0.0
    container_name: superset_init
    # This service runs the commands, referencing variables from the .env file.
    command: /bin/bash -c "superset db upgrade && superset fab create-admin --username $SUPERSET_ADMIN_USERNAME --firstname Superset --lastname Admin --email $SUPERSET_ADMIN_EMAIL --password $SUPERSET_ADMIN_PASSWORD && superset init && echo 'Initialization complete. Pausing for 10 seconds...' && sleep 10"

    env_file:
      - ./.env # Load credentials from the .env file
    depends_on:
      - hive-metastore # Wait for the Metastore to be ready (even though it uses SQLite)
    networks:
      - my_shared_network

  # -------------------------------------------------------------------------
  # Superset Webserver Service
  # Runs the actual UI server
  # -------------------------------------------------------------------------
  superset:
    image: apache/superset:3.0.0
    container_name: superset_app
    ports:
      - "8088:8088"
    environment:
      - SUPERSET_LOAD_EXAMPLES=false
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY} # Reference secret key from .env
    env_file:
      - ./.env # Load secret key from the .env file
    depends_on:
      - superset-init # Wait for the database and admin user to be created
    networks:
      - my_shared_network

# -------------------------------------------------------------------------
# Docker Networks and Volumes
# -------------------------------------------------------------------------
networks:
  # This external network must be created separately OR
  # declared as 'external: true' in here but internal in the first yaml so its created there.
  my_shared_network:
    name: my_shared_network
    external: true

volumes:
  # Volume for persistent storage of the SQLite database file
  sqlite_data:
